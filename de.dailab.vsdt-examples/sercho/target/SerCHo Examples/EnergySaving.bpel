<?xml version="1.0" encoding="ASCII"?>
<bpws:process xmlns:bpws="http://schemas.xmlsoap.org/ws/2003/03/business-process/" xmlns:ns1="http://EnergySaving/WSDL/" xmlns:xsd="http://www.w3.org/2001/XMLSchema" abstractProcess="no" enableInstanceCompensation="no" expressionLanguage="http://www.w3.org/TR/1999/REC-xpath-19991116" name="EnergySaving" queryLanguage="" suppressJoinFailure="no" targetNamespace="http://EnergySaving">
  <bpws:partnerLinks>
    <bpws:partnerLink myRole="SHEA_myRole" name="SHEA" partnerLinkType="ns1:SHEA_PLT"/>
    <bpws:partnerLink name="Logger" partnerLinkType="ns1:Logger_PLT" partnerRole="Logger_partnerRole"/>
    <bpws:partnerLink name="LocationProvider" partnerLinkType="ns1:LocationProvider_PLT" partnerRole="LocationProvider_partnerRole"/>
    <bpws:partnerLink name="Ivistar" partnerLinkType="ns1:Ivistar_PLT" partnerRole="Ivistar_partnerRole"/>
    <bpws:partnerLink name="Radio" partnerLinkType="ns1:Radio_PLT" partnerRole="Radio_partnerRole"/>
  </bpws:partnerLinks>
  <bpws:variables>
    <bpws:variable messageType="ns1:ESStartMessage_MessageDataMessage" name="ESStartMessage_MessageData"/>
    <bpws:variable messageType="ns1:logRequest_MessageDataMessage" name="logRequest_MessageData"/>
    <bpws:variable messageType="ns1:IsInZoneRequest_MessageDataMessage" name="IsInZoneRequest_MessageData"/>
    <bpws:variable messageType="ns1:IsInZoneResponse_MessageDataMessage" name="IsInZoneResponse_MessageData"/>
    <bpws:variable messageType="ns1:SetValueRequest_MessageDataMessage" name="SetValueRequest_MessageData"/>
    <bpws:variable messageType="ns1:PlayPauseRequest_MessageDataMessage" name="PlayPauseRequest_MessageData"/>
    <bpws:variable name="CheckPosition_loopCounter" type="xsd:integer"/>
    <bpws:variable messageType="ns1:ESStopMessage_MessageDataMessage" name="ESStopMessage_MessageData"/>
    <bpws:variable messageType="ns1:EnergySavingProcess_ProcessDataMessage" name="EnergySavingProcess_ProcessData"/>
  </bpws:variables>
  <bpws:sequence>
    <bpws:receive name="" createInstance="yes" operation="start" partnerLink="SHEA" portType="ns1:EnergySavingPT" variable="ESStartMessage_MessageData"/>
    <bpws:assign name="EnergySaving_startAssignments_and__endAssignments_and_log_startAssignments">
      <bpws:copy>
        <bpws:from expression="1"/>
        <bpws:to part="tmpState" variable="EnergySavingProcess_ProcessData"/>
      </bpws:copy>
      <bpws:copy>
        <bpws:from expression="1"/>
        <bpws:to part="tmpLastState" variable="EnergySavingProcess_ProcessData"/>
      </bpws:copy>
      <bpws:copy>
        <bpws:from expression="bpws:getVariableData('ESStartMessage_MessageData','paramUserName')"/>
        <bpws:to part="inUserName" variable="EnergySavingProcess_ProcessData"/>
      </bpws:copy>
      <bpws:copy>
        <bpws:from expression="bpws:getVariableData('ESStartMessage_MessageData','paramDelaySec')"/>
        <bpws:to part="inDelay" variable="EnergySavingProcess_ProcessData"/>
      </bpws:copy>
      <bpws:copy>
        <bpws:from expression="bpws:getVariableData('ESStartMessage_MessageData','paramZone')"/>
        <bpws:to part="inZone" variable="EnergySavingProcess_ProcessData"/>
      </bpws:copy>
      <bpws:copy>
        <bpws:from expression="bpws:getVariableData('ESStartMessage_MessageData','paramLightLine')"/>
        <bpws:to part="inLightLine" variable="EnergySavingProcess_ProcessData"/>
      </bpws:copy>
      <bpws:copy>
        <bpws:from expression="bpws:getVariableData('ESStartMessage_MessageData','paramRoom')"/>
        <bpws:to part="inRoom" variable="EnergySavingProcess_ProcessData"/>
      </bpws:copy>
      <bpws:copy>
        <bpws:from expression="'Energy Saving Process started'"/>
        <bpws:to part="message" variable="logRequest_MessageData"/>
      </bpws:copy>
      <bpws:copy>
        <bpws:from expression="1"/>
        <bpws:to part="level" variable="logRequest_MessageData"/>
      </bpws:copy>
    </bpws:assign>
    <bpws:invoke name="log" inputVariable="logRequest_MessageData" operation="log" partnerLink="Logger" portType="ns1:LoggingPT"/>
    <bpws:scope>
      <bpws:faultHandlers>
        <bpws:catch faultName="ESStopMessage_Exit">
          <bpws:empty/>
        </bpws:catch>
      </bpws:faultHandlers>
      <bpws:eventHandlers>
        <bpws:onMessage operation="stop" partnerLink="SHEA" portType="ns1:EnergySavingPT" variable="ESStopMessage_MessageData">
          <bpws:throw faultName="ESStopMessage_Exit"/>
        </bpws:onMessage>
      </bpws:eventHandlers>
      <bpws:sequence>
        <bpws:assign name="CheckPosition_initialize_loopCounter">
          <bpws:copy>
            <bpws:from expression="0"/>
            <bpws:to variable="CheckPosition_loopCounter"/>
          </bpws:copy>
        </bpws:assign>
        <bpws:while condition="true()">
          <bpws:sequence>
            <bpws:scope name="CheckPosition">
              <bpws:sequence>
                <bpws:assign name="wait_startAssignments">
                  <bpws:copy>
                    <bpws:from expression="bpws:getVariableData('EnergySavingProcess_ProcessData','tmpState')"/>
                    <bpws:to part="tmpLastState" variable="EnergySavingProcess_ProcessData"/>
                  </bpws:copy>
                </bpws:assign>
                <bpws:wait name="wait" for="concat('PT',concat(bpws:getVariableData('EnergySavingProcess_ProcessData','inDelay'),'S'))"/>
                <bpws:assign name="getPos_startAssignments">
                  <bpws:copy>
                    <bpws:from expression="bpws:getVariableData('EnergySavingProcess_ProcessData','inUserName')"/>
                    <bpws:to part="username" variable="IsInZoneRequest_MessageData"/>
                  </bpws:copy>
                  <bpws:copy>
                    <bpws:from expression="bpws:getVariableData('EnergySavingProcess_ProcessData','inZone')"/>
                    <bpws:to part="zone" variable="IsInZoneRequest_MessageData"/>
                  </bpws:copy>
                </bpws:assign>
                <bpws:invoke name="getPos" inputVariable="IsInZoneRequest_MessageData" operation="IsInZone" outputVariable="IsInZoneResponse_MessageData" partnerLink="LocationProvider" portType="ns1:SheaSimulatorPT"/>
                <bpws:assign name="getPos_endAssignments_and_log_startAssignments">
                  <bpws:copy>
                    <bpws:from expression="bpws:getVariableData('IsInZoneResponse_MessageData','isin')"/>
                    <bpws:to part="tmpState" variable="EnergySavingProcess_ProcessData"/>
                  </bpws:copy>
                  <bpws:copy>
                    <bpws:from expression="concat('State: ',concat(bpws:getVariableData('EnergySavingProcess_ProcessData','tmpState'),concat(', last State: ',bpws:getVariableData('EnergySavingProcess_ProcessData','tmpLastState'))))"/>
                    <bpws:to part="message" variable="logRequest_MessageData"/>
                  </bpws:copy>
                  <bpws:copy>
                    <bpws:from expression="1"/>
                    <bpws:to part="level" variable="logRequest_MessageData"/>
                  </bpws:copy>
                </bpws:assign>
                <bpws:invoke name="log" inputVariable="logRequest_MessageData" operation="log" partnerLink="Logger" portType="ns1:LoggingPT"/>
                <bpws:switch>
                  <bpws:case condition="bpws:getVariableData('EnergySavingProcess_ProcessData','tmpState') != bpws:getVariableData('EnergySavingProcess_ProcessData','tmpLastState')">
                    <bpws:sequence>
                      <bpws:assign name="log_startAssignments">
                        <bpws:copy>
                          <bpws:from expression="'State changed'"/>
                          <bpws:to part="message" variable="logRequest_MessageData"/>
                        </bpws:copy>
                        <bpws:copy>
                          <bpws:from expression="1"/>
                          <bpws:to part="level" variable="logRequest_MessageData"/>
                        </bpws:copy>
                      </bpws:assign>
                      <bpws:invoke name="log" inputVariable="logRequest_MessageData" operation="log" partnerLink="Logger" portType="ns1:LoggingPT"/>
                      <bpws:assign name="SwitchLight_startAssignments">
                        <bpws:copy>
                          <bpws:from expression="bpws:getVariableData('EnergySavingProcess_ProcessData','tmpState') * 100"/>
                          <bpws:to part="value" variable="SetValueRequest_MessageData"/>
                        </bpws:copy>
                        <bpws:copy>
                          <bpws:from expression="bpws:getVariableData('EnergySavingProcess_ProcessData','inLightLine')"/>
                          <bpws:to part="line" variable="SetValueRequest_MessageData"/>
                        </bpws:copy>
                        <bpws:copy>
                          <bpws:from expression="bpws:getVariableData('EnergySavingProcess_ProcessData','inRoom')"/>
                          <bpws:to part="room" variable="SetValueRequest_MessageData"/>
                        </bpws:copy>
                      </bpws:assign>
                      <bpws:invoke name="SwitchLight" inputVariable="SetValueRequest_MessageData" operation="SetValue" partnerLink="Ivistar" portType="ns1:IvistarProxyPT"/>
                      <bpws:assign name="SwitchMusic_startAssignments">
                        <bpws:copy>
                          <bpws:from expression="bpws:getVariableData('EnergySavingProcess_ProcessData','tmpState')"/>
                          <bpws:to part="paramState" variable="PlayPauseRequest_MessageData"/>
                        </bpws:copy>
                      </bpws:assign>
                      <bpws:invoke name="SwitchMusic" inputVariable="PlayPauseRequest_MessageData" operation="PlayPause" partnerLink="Radio" portType="ns1:UPnPRadioPT"/>
                    </bpws:sequence>
                  </bpws:case>
                  <bpws:otherwise>
                    <bpws:empty name="DoNothing"/>
                  </bpws:otherwise>
                </bpws:switch>
              </bpws:sequence>
            </bpws:scope>
            <bpws:assign name="CheckPosition_increment_loopCounter">
              <bpws:copy>
                <bpws:from expression="bpws:getVariableData('CheckPosition_loopCounter') + 1"/>
                <bpws:to variable="CheckPosition_loopCounter"/>
              </bpws:copy>
            </bpws:assign>
          </bpws:sequence>
        </bpws:while>
      </bpws:sequence>
    </bpws:scope>
    <bpws:empty name="_MERGE"/>
    <bpws:assign name="_startAssignments">
      <bpws:copy>
        <bpws:from expression="'Energy Saving Process stopped'"/>
        <bpws:to part="message" variable="logRequest_MessageData"/>
      </bpws:copy>
      <bpws:copy>
        <bpws:from expression="1"/>
        <bpws:to part="level" variable="logRequest_MessageData"/>
      </bpws:copy>
    </bpws:assign>
    <bpws:invoke name="" inputVariable="logRequest_MessageData" operation="log" partnerLink="Logger" portType="ns1:LoggingPT"/>
  </bpws:sequence>
</bpws:process>